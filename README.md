# Purview Analyzer

Purview Analyzer is a Presidio-derived Streamlit app for:

- PII detection and anonymization with multiple NER backends.
- Entity catalog browsing from recognizers in `predefined_recognizers/`.
- Recognizer authoring in the web UI (session-only and persistent).
- File extraction from office docs, PDFs/images (OCR), archives, `.eml`, and `.msg`.

## Quick start

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
streamlit run presidio_streamlit.py
```

Optional API:

```bash
uvicorn app.api:app --reload
```

## UI pages

- `App`: upload files or paste text, analyze entities, anonymize output.
- `Entities`: lists imported entities from recognizer source files.
- `Recognizers`:
  - `Ad-hoc (Session)`: JSON import, validate/load/remove; in-memory only.
  - `Persistent (Saved)`: create/update/delete recognizers saved to DB and Python modules.

## Recognizer persistence behavior

Persistent recognizers are generated under `predefined_recognizers/` (not `custom_recognizers`).

- File/class are explicitly configurable in the form:
  - `Recognizer class` (for example `AuBsbStgRecognizer`)
  - `File name` (for example `au_bsb_stg_recognizer.py`)
- Storage folder is selected from existing folders under `predefined_recognizers/` and defaults to `generic`.
- On save, the app:
  - Writes/updates the Python module file.
  - Updates exports in the relevant `__init__.py` for the selected subfolder.
  - Updates exports in `predefined_recognizers/__init__.py`.
  - Stores recognizer metadata/patterns/context in the SQLite DB.

Advanced validators/checksum logic are not generated by the form yet; generated classes keep a `validate_result` hook that currently returns `True`.

## File extraction behavior

Supported upload types:

- `.7z`, `.zip`, `.rar`
- `.docx`, `.pptx`, `.xlsx`, `.xls`, `.rtf`, `.odt`
- `.pdf`
- `.jpg`, `.jpeg`, `.png`, `.tif`, `.tiff`, `.gif`
- `.eml`, `.msg`

Runtime behavior:

- Archive uploads are extracted, every extracted file is queued and shown in extraction status, then processed one-by-one.
- `.eml` and `.msg` are itemized into `body.txt` plus each attachment, and each item is extracted/scanned.
- PDF extraction uses direct text first (PyMuPDF/pypdf), then OCR fallback.
- OCR path includes normalization for document identifiers and passport/MRZ-friendly post-processing to improve regex matching.

Key extraction limits (all env-overridable):

- `MAX_EXTRACTED_TEXT_CHARS` default `400000`
- `MAX_FILE_TEXT_CHARS` default `200000`
- `OCR_PDF_DPI` default `200`
- `MAX_OCR_PDF_PAGES` default `50`
- `MAX_ARCHIVE_FILES` default `2000`
- `MAX_ARCHIVE_BYTES` default `209715200` (200MB)
- `MAX_IMAGE_PIXELS` default `6000000`
- `MAX_MESSAGE_ATTACHMENTS` default `100`
- `MAX_ATTACHMENT_BYTES` default `52428800` (50MB)
- `USE_EASYOCR` default `0` (Tesseract is primary path)
- `OCR_LANG` default `eng`
- `OCR_MRZ_LANG` default `ocrb`

## Database path and migration

The app uses SQLite by default and resolves DB path as:

- Azure or writable `/mnt`: `/mnt/data/app.db`
- Otherwise local: `./mnt/data/app.db` (resolved to absolute path at runtime)

Configuration:

- `DB_PATH`: explicit SQLite file path
- `DATABASE_URL`: full SQLAlchemy URL (takes precedence over `DB_PATH`)
- `PREDEFINED_RECOGNIZERS_PATH`: recognizer root (default `./predefined_recognizers`)
- `AUTO_IMPORT_ENTITIES`: auto-refresh entity import from recognizer source files

Startup DB behavior:

- Creates parent directory for SQLite path automatically.
- Applies SQLite pragmas (`WAL`, busy timeout).
- Retries table initialization on transient `database is locked`.

## Model cache persistence

Model caches are initialized on startup (`init_model_storage`) and redirected to a persistent root.

- `PURVIEW_PERSIST_ROOT`: override persist root
- `VERIFY_MNT_WRITABLE`: verify mount writability (`1/true/yes/on`)
- `PURVIEW_CLEAN_LEGACY_MODEL_DIRS`: cleanup old caches under `/root` (default enabled)

Default root resolution:

- `PURVIEW_PERSIST_ROOT` if set
- else `/mnt` if present
- else `./mnt` if present
- else ephemeral temp directory

Verify mount/caches:

```bash
python -m purviewanalyzer.verify_storage
```

## Import entities from recognizer source

```bash
python -m app.import_entities
```

or

```bash
python scripts/import_entities.py
```

## Local docs pages

The app renders local docs from `content/docs/` for:

- `Tutorial`
- `Installation`
- `FAQ`

Sync docs:

```bash
python scripts/sync_docs.py
```

Sync one page:

```bash
python scripts/sync_docs.py --page faq
```

## Notes

- Streamlit currently logs a deprecation warning for `use_container_width`; this is expected from upstream API changes.
- For deployment, see `.github/workflows/deploy-containerapp.yml` and `Dockerfile`.
